# Feature 4.1: Output Folder Control

## Summary

Provide UI controls and validation for selecting an output folder where generated XML route files will be written. The control must ensure the folder is writable and persist the last-used path between runs.

## Goals

- Allow users to pick an output folder using a standard folder picker.
- Validate write permissions to the selected folder before enabling processing.
- Persist last-used output folder path in application settings.
- Display clear, actionable error messages when the folder is not writable.

## Dependencies

- Iteration 1: Data models (for output filename pattern)
- Iteration 2: File parsing (to ensure input is available)
- System: cross-platform file I/O (use .NET APIs and Avalonia abstractions)

## User Stories

- As a user, I can select an output folder so that generated XML files are saved where I expect.
- As a user, I see a clear error if the chosen folder is not writable and the process button remains disabled.
- As a user, the application remembers my last chosen output folder on next launch.

## UI Controls

- **Output Folder Path**: read-only text field that shows the currently selected path.
- **Browse...** button: opens a folder picker dialog to select a folder.
- **Validate** indicator: small status icon/text showing `Valid` / `Not writable` / `Not selected`.
- Tooltip or inline help: short instruction about required permissions.

## Behaviour & Validation

- When the user clicks `Browse...`, show native folder picker.
- On selection, perform synchronous validation:
  - Check path exists.
  - Attempt to create and delete a small temporary file to verify write access.
  - If the create/delete succeeds, mark folder as writable and enable the `Process` button (assuming other prerequisites are met).
  - If it fails, mark as `Not writable` and show an error explaining common causes (permissions, read-only media).
- If the path is a network location or UNC, ensure timeouts and exception handling are robust.

## Persistence

- Store last-used output path in a simple settings store (cross-platform):
  - Use a JSON settings file under the user's application data directory, or use Avalonia's built-in settings service if available.
  - Key: `lastOutputFolder`

## Data Model Impact

- No schema changes required. The output filename is generated by the XML export feature using `ShipStaticData`, `TimeInterval`, and `RouteWaypoint` models. The folder path is an application-level preference used during export.

## BDD Scenarios (Gherkin)

Scenario: Select writable output folder
  Given the application is running
  When the user selects a folder with write permission
  Then the output path is displayed
  And the validate indicator shows "Valid"
  And the process button may be enabled if other prerequisites are satisfied

Scenario: Reject non-writable folder
  Given the application is running
  When the user selects a folder without write permission
  Then the validate indicator shows "Not writable"
  And an inline error message explains the failure
  And the process button remains disabled

Scenario: Remember last-used output path
  Given the user selected an output folder and closed the app
  When the user re-opens the application
  Then the output folder text field shows the previously selected path

## Acceptance Criteria

- Selecting a writable folder displays the path and enables processing when other prerequisites satisfied.
- Selecting a non-writable folder displays a clear error and prevents processing.
- The last-used folder is restored on app launch.
- Validation uses an actual write test (create & delete temp file) rather than relying solely on folder attributes.

## Testing Notes

- Unit tests should mock the file system layer; integration tests should run against a temporary folder.
- Add tests for:
  - Writable folder detection (create/delete succeeds)
  - Non-writable folder detection (simulate permission denied)
  - Persistence of `lastOutputFolder` across app restarts (using a temporary settings file)

## Files / Code To Add

- UI component: `OutputFolderControl` (Avalonia UserControl) with bindings to view model properties `OutputPath`, `IsWritable`, `ValidationMessage`.
- ViewModel: `OutputFolderViewModel` with command `BrowseCommand` and method `ValidateOutputFolderAsync(string path)`.
- Settings helper: `AppSettings` with `GetLastOutputFolder()` and `SetLastOutputFolder(string)`.
- Tests: `tests/output_folder_validation.spec.ts`, `tests/output_folder_persistence.spec.ts`.

## Implementation Notes

- Use synchronous validation to keep UI responsive on simple local folders. For network paths, consider running validation on a background task.
- Avoid elevated privilege prompts â€” prefer failing validation and instructing the user to run the app with appropriate rights.
- Keep UX simple: if the folder is valid show a green check, otherwise a clear red cross and short message.
